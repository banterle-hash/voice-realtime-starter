<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Realtime Voice — Terminal Mode</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg:#0a0b0d; --panel:#101215; --border:#1b1e24; --text:#cfe7cf; --muted:#7aa07a;
    --accent:#36d399; --accent-2:#7af7c6; --danger:#ff6b6b; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  html,body { height:100%; }
  body {
    margin:0; background: radial-gradient(1200px 800px at 20% 10%, #0d1117 0%, #0a0b0d 60%, #07080a 100%);
    color:var(--text); font-family: var(--mono); font-size:14px; letter-spacing:0.2px;
    overflow-y: auto;
  }
  .scanlines:before {
    content:""; pointer-events:none; position:fixed; inset:0;
    background: repeating-linear-gradient(0deg, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 1px, transparent 1px, transparent 3px);
    mix-blend-mode: soft-light; opacity:.07;
  }
  .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
  .titlebar {
    display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;
    color:var(--muted);
  }
  .led {
    width:10px; height:10px; border-radius:50%; background: #0f5132; box-shadow:0 0 6px #0f5132;
    margin-right:8px; display:inline-block; vertical-align:middle;
  }
  .window {
    background: var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden;
    box-shadow: 0 6px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,0.03);
  }
  .window .header {
    padding:10px 12px; display:flex; align-items:center; gap:10px; background:#0d0f13; border-bottom:1px solid var(--border);
  }
  .dot { width:10px; height:10px; border-radius:50%; background:#2a2e36; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }
  .dot.red { background:#ff5f56; } .dot.yellow { background:#ffbd2e; } .dot.green { background:#27c93f; }
  .header .path { color:var(--muted); opacity:.9; }
  .content { padding:14px; }
  .grid { display:grid; gap:12px; }
  .two { grid-template-columns: 1.2fr .8fr; }
  label { color:#9ad39a; font-weight:600; font-size:12px; }
  textarea, input, select, button, .kbd, .code {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0c0f12; color:var(--text);
    font-family: var(--mono);
  }
  textarea { height:180px; resize:vertical; }
  select { background:#0c0f12; }
  input::placeholder, textarea::placeholder { color:#536b53; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  button { cursor:pointer; background:linear-gradient(180deg, #1d3d2c, #14281e); border:1px solid #1f3f2f; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
  button.secondary { background:linear-gradient(180deg,#171b21,#12161b); border:1px solid #232a33; }
  button:hover { box-shadow: 0 0 0 1px #2d5a44, 0 0 18px rgba(54,211,153,.25) inset; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .inline { display:flex; gap:10px; align-items:center; }
  .hint { color:#7aa07a; }
  .muted { color:#6e876e; }
  .ok { color:#7ef5b4; }
  .err { color:#ff9fa0; }
  .panel { padding:12px; border:1px dashed #2a2f37; border-radius:10px; background:#0b0e11; }
  .code { background:#0a0d10; line-height:1.45; white-space:pre; overflow:auto; }
  .section-title { color:#a3e4a3; margin:4px 0 8px; font-weight:800; letter-spacing:0.6px; }
  .toolbar { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
  .badge { display:inline-block; padding:2px 8px; border:1px solid #244; border-radius:999px; font-size:12px; color:#a6cfa6; background:#0b1012; }
  .number-pill { font-weight:800; color:#a8ffce; }
  .statusbar { margin-top:10px; font-size:12px; color:#6f8b6f; display:flex; justify-content:space-between; }
  .kbd { display:inline-block; padding:4px 8px; background:#0d1215; border:1px solid #26323a; border-radius:6px; font-weight:700; font-size:12px; }
</style>
</head>
<body class="scanlines">
  <div class="wrap">
    <div class="titlebar">
      <div><span class="led"></span>Realtime Voice — <span class="muted">Terminal Mode</span></div>
      <div class="badge" id="hostBadge">host: …</div>
    </div>

    <div class="window">
      <div class="header">
        <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
        <div class="path">/voice/realtime$</div>
      </div>
      <div class="content grid two">
        <div class="grid">

          <!-- Base rules (read-only) -->
          <div class="panel">
            <div class="section-title">Base rules (always applied)</div>
            <div class="muted">
              • English only • Wait ~0.6–1.0s before replying • Don’t talk over the caller • 1–2 short sentences • Ask brief clarifying questions when needed
            </div>
          </div>

          <!-- Preset + Instructions -->
          <div class="inline">
            <div style="flex:2">
              <label for="preset">Preset</label>
              <select id="preset">
                <option value="">— Select a preset —</option>
                <option value="Be a cheerful concierge. Greet the caller by name if provided, ask how you can help, keep answers to one sentence. Clarify if you’re unsure.">Cheerful concierge</option>
                <option value="You are an appointment scheduler for a clinic. Verify the caller’s name, propose 2 time slots in the next 7 days, and confirm by repeating it back.">Clinic appointment scheduler</option>
                <option value="You are a calm IT help desk agent. Ask for device and OS, suggest one actionable step at a time. Avoid jargon. ≤ 20 words per response.">Calm IT help desk</option>
                <option value="You are a friendly order status assistant. Ask for an order number, confirm the last 2 digits back, and summarize the status in one line.">Order status assistant</option>
              </select>
            </div>
            <button id="usePreset" class="secondary" style="flex:1;margin-top:18px">Use preset</button>
          </div>

          <label for="instr">Instructions (prompt)</label>
          <textarea id="instr" placeholder="Add any caller-specific rules here…"></textarea>

          <div class="row">
            <div>
              <label for="voice">Voice</label>
              <select id="voice">
                <option>alloy</option><option>ash</option><option>ballad</option><option>coral</option>
                <option>echo</option><option>sage</option><option>shimmer</option><option selected>verse</option>
              </select>
            </div>
            <div>
              <label for="phone">Your phone (+15551234567)</label>
              <input id="phone" placeholder="+15551234567" class="kbd" />
            </div>
          </div>

          <div class="inline">
            <button id="callBtn">Call me</button>
            <button id="genBtn" class="secondary">Generate inbound URL & TwiML</button>
            <span id="msg" class="hint"></span>
          </div>

          <!-- Results -->
          <div id="results" class="panel" style="display:none">
            <div class="section-title">Inbound testing assets</div>
            <div class="grid">
              <div><b>Webhook URL</b> <span class="muted">(POST)</span>
                <div class="inline" style="margin-top:6px">
                  <input id="webhook" readonly class="kbd" />
                  <button id="copyWebhook" class="secondary" style="max-width:120px">Copy</button>
                </div>
              </div>

              <div>
                <b>TwiML Bin XML</b>
                <div class="toolbar">
                  <button id="copyTwiml" class="secondary">Copy TwiML</button>
                </div>
                <pre id="twiml" class="code" style="margin-top:6px"></pre>
              </div>
            </div>
          </div>

        </div>

        <!-- Right column: Call-in info & diagnostics -->
        <div class="grid">
          <div class="panel">
            <div class="section-title">Call-in</div>
            <div class="muted">Dial your Twilio number to reach the app.</div>
            <div style="margin-top:8px">
              <span class="muted">Number:</span>
              <span id="callInNumber" class="number-pill">—</span>
            </div>
          </div>

          <div class="panel">
            <div class="section-title">Tips</div>
            <ul class="muted" style="margin:6px 0 0 18px; line-height:1.5">
              <li>Use handset over speakerphone for clearer VAD.</li>
              <li>Pause ~1s when you finish talking.</li>
              <li>Need instant barge-in? (we can cancel speech on new audio)</li>
            </ul>
          </div>
        </div>

      </div>
      <div class="statusbar">
        <div>press <span class="kbd">⌘</span> <span class="kbd">C</span> to copy snippets</div>
        <div id="status">ready</div>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const set = (id, v) => ($(id).textContent = v);
const show = (id, on=true) => ($(id).style.display = on ? "" : "none");
const toast = (t, ok=true) => { $("status").textContent = t; $("status").style.color = ok ? "#7ef5b4" : "#ff9fa0"; setTimeout(()=>{$("status").textContent="ready"; $("status").style.color="";}, 1600); };

(async function boot(){
  try {
    const cfg = await fetch("/api/config").then(r=>r.json());
    set("hostBadge", "host: " + (cfg.baseUrl || location.origin));
    $("voice").value = (cfg.voices?.includes("verse") ? "verse" : (cfg.voices?.[0] || "alloy"));
    set("callInNumber", cfg.twilioFrom || "— (set TWILIO_FROM in .env)");
  } catch {
    // no-op
  }
})();

$("usePreset").onclick = () => { const v = $("preset").value; if (v) $("instr").value = v; };

$("callBtn").onclick = async () => {
  const to = $("phone").value.trim();
  const voice = $("voice").value;
  const instructions = $("instr").value.trim();
  if (!instructions) return toast("Enter instructions", false);
  if (!/^\+\d{10,15}$/.test(to)) return toast("Phone must be +E164", false);

  $("callBtn").disabled = true;
  set("msg","dialing…");
  try {
    const p = await fetch("/api/prompts", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ instructions, voice }) }).then(r=>r.json());
    if (!p.promptId) throw new Error(p.error || "No promptId");
    const c = await fetch("/api/call", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ to, promptId: p.promptId }) }).then(r=>r.json());
    if (!c.ok) throw new Error(c.error || "Call failed");
    set("msg","Call placed!", true); toast("Outbound call placed");
  } catch(e) {
    set("msg",""); toast(e.message || "error", false);
  } finally {
    $("callBtn").disabled = false;
  }
};

$("genBtn").onclick = async () => {
  const voice = $("voice").value;
  const instructions = $("instr").value.trim();
  if (!instructions) return toast("Enter instructions", false);

  $("genBtn").disabled = true;
  try {
    const p = await fetch("/api/prompts", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ instructions, voice }) }).then(r=>r.json());
    if (!p.promptId) throw new Error(p.error || "No promptId");

    // get host from config to avoid localhost
    const cfg = await fetch("/api/config").then(r=>r.json());
    const base = (cfg.baseUrl || location.origin).replace(/\/$/,"");
    const webhookUrl = `${base}/twiml?promptId=${encodeURIComponent(p.promptId)}`;
    $("webhook").value = webhookUrl;

    const streamUrl = `wss://${base.replace(/^https?:\/\//,"")}/stream`;
    const xml = `<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Connect>
    <Stream url="${streamUrl}">
      <Parameter name="promptId" value="${p.promptId}"/>
      <Parameter name="voice" value="${voice}"/>
    </Stream>
  </Connect>
  <Pause length="3600"/>
</Response>`;
    $("twiml").textContent = xml;

    show("results", true);
    toast("Generated inbound assets");
  } catch(e) {
    toast(e.message || "error", false);
  } finally {
    $("genBtn").disabled = false;
  }
};

$("copyWebhook").onclick = async () => {
  try { await navigator.clipboard.writeText($("webhook").value); toast("Webhook URL copied"); }
  catch { toast("Copy failed", false); }
};
$("copyTwiml").onclick = async () => {
  try { await navigator.clipboard.writeText($("twiml").textContent); toast("TwiML copied"); }
  catch { toast("Copy failed", false); }
};
</script>
</body>
</html>
